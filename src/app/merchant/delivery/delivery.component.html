<div class="container-fluid p-3 p-md-5">
  <!-- Header -->
   <div class="section-header">
          <h2><i class="bi bi-receipt"></i>Livreurs</h2>
          
        </div>

  <!-- Search Filters -->
  <div class="row mb-4 g-3">
    <div class="col-12 col-md-4">
      <label class="form-label small text-muted mb-2">Recherche par nom</label>
      <div class="search-container position-relative">
      <input 
        type="text" 
        class="search-input" 
        placeholder="Rechercher un livreur..."/>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label small text-muted mb-2">Zone / Ville</label>
      <div class="search-container position-relative">
      <input 
        type="text" 
        class="search-input" 
        placeholder="Ville...">
      </div>
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label small text-muted mb-2">Type de véhicule</label>
      <div class="search-container position-relative">
      <input 
        type="text" 
        class="search-input" 
        placeholder="Type de véhicule...">
      </div>
    </div>
  </div>

  <!-- Delivery Drivers Table -->
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th class="text-center">Photo livreur</th>
          <th class="text-center">Nom du livreur</th>
          <th class="text-center">
            Note 
            <i class="bi bi-star-fill text-warning ms-1"></i>
          </th>
          <th class="text-center">Type de véhicule</th>
          <th class="text-center">Délai</th>
          <th class="text-center">Status</th>
          <th class="text-center">Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let delivery of deliveries">
          <td class="text-center">
            <div class="driver-photo-container">
              <img [src]="delivery.photo || 'assets/images/avatar-placeholder.png'" 
                   alt="Driver" 
                   class="driver-photo">
              <span class="driver-id">{{ delivery.id }}</span>
            </div>
          </td>
          <td class="text-center fw-semibold">{{ delivery.nomComplet }}</td>
          <td class="text-center">
            <div class="rating">
              <i *ngFor="let filled of getStarArray(delivery.note)" 
                 class="bi" 
                 [class.bi-star-fill]="filled"
                 [class.bi-star]="!filled"
                 class="text-warning"></i>
            </div>
          </td>
          <td class="text-center">
            <span class="badge" [ngClass]="getVehicleBadgeClass(delivery.typeVehicule)">
              <i class="bi bi-{{ getVehicleIcon(delivery.typeVehicule) }} me-1"></i>
              {{ delivery.typeVehicule }}
            </span>
          </td>
          <td class="text-center">{{ delivery.delai }}</td>
          <td class="text-center">
            <span class="badge" 
                  [class.bg-success]="isDriverAvailable(delivery)"
                  [class.bg-secondary]="!isDriverAvailable(delivery)">
              {{ delivery.status }}
            </span>
          </td>
          <td class="text-center">
            <button class="btn btn-outline-primary btn-sm" 
                    (click)="openDriverDrawer(delivery)"
                    [disabled]="!isDriverAvailable(delivery)">
              Choisir livreur
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Loading spinner -->
    <div class="text-center py-5" *ngIf="isLoading">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Chargement...</span>
      </div>
      <p class="mt-2 text-muted">Chargement des livreurs...</p>
    </div>

    <!-- No data message -->
    <div class="alert alert-info text-center" *ngIf="deliveries.length === 0 && !isLoading">
      <i class="bi bi-inbox fs-1 d-block mb-3"></i>
      <h5>Aucun livreur trouvé</h5>
      <p class="text-muted">Les livreurs disponibles apparaîtront ici.</p>
    </div>
  </div>

  <!-- Pagination -->
  <div class="row mt-3 g-2" *ngIf="deliveries.length > 0">
    <div class="col-12 col-md-6 text-center text-md-start">
      <p class="text-muted mb-2 mb-md-0 small">
        Affichage de {{ currentPage * pageSize + 1 }} à 
        {{ (currentPage + 1) * pageSize > totalItems ? totalItems : (currentPage + 1) * pageSize }} 
        sur {{ totalItems }} livreurs
      </p>
    </div>
    <div class="col-12 col-md-6">
      <nav aria-label="Page navigation">
        <ul class="pagination pagination-sm justify-content-center justify-content-md-end mb-0">
          <li class="page-item" [class.disabled]="currentPage === 0">
            <a class="page-link" (click)="previousPage()" style="cursor: pointer;" tabindex="-1">
              <i class="bi bi-chevron-left"></i> <span class="d-none d-sm-inline">Précédent</span>
            </a>
          </li>
          <li class="page-item" 
              *ngFor="let page of getPageNumbers()"
              [class.active]="page === currentPage">
            <a class="page-link" (click)="goToPage(page)" style="cursor: pointer;">
              {{ page + 1 }}
            </a>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
            <a class="page-link" (click)="nextPage()" style="cursor: pointer;">
              <span class="d-none d-sm-inline">Suivant</span> <i class="bi bi-chevron-right"></i>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- Driver Selection Offcanvas (Bootstrap alternative) -->
<div class="offcanvas offcanvas-end" 
     [class.show]="driverDrawerVisible" 
     [style.visibility]="driverDrawerVisible ? 'visible' : 'hidden'"
     tabindex="-1">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Détails du livreur</h5>
    <button type="button" class="btn-close" (click)="closeDriverDrawer()"></button>
  </div>
  <div class="offcanvas-body" *ngIf="selectedDriver">
    <div class="text-center mb-4">
      <img [src]="selectedDriver.photo || 'assets/images/avatar-placeholder.png'" 
           alt="Driver" 
           class="driver-detail-photo mb-3">
      <h5 class="mb-1">{{ selectedDriver.nomComplet }}</h5>
    </div>

    <div class="driver-details mb-4">
      <div class="detail-row mb-3">
        <label class="detail-label">Note</label>
        <div class="detail-value">
          <div class="rating">
            <i *ngFor="let filled of getStarArray(selectedDriver.note)" 
               class="bi" 
               [class.bi-star-fill]="filled"
               [class.bi-star]="!filled"
               class="text-warning"></i>
            <span class="ms-2">({{ selectedDriver.note }}/5)</span>
          </div>
        </div>
      </div>

      <div class="detail-row mb-3">
        <label class="detail-label">Véhicule</label>
        <div class="detail-value">
          <span class="badge" [ngClass]="getVehicleBadgeClass(selectedDriver.typeVehicule)">
            <i class="bi bi-{{ getVehicleIcon(selectedDriver.typeVehicule) }} me-1"></i>
            {{ selectedDriver.typeVehicule }}
          </span>
        </div>
      </div>

      <div class="detail-row mb-3">
        <label class="detail-label">Numéro d'immatriculation</label>
        <div class="detail-value">
          <span class="badge bg-dark">{{ selectedDriver.numImmatriculation }}</span>
        </div>
      </div>

      <div class="detail-row mb-3">
        <label class="detail-label">Délai</label>
        <div class="detail-value">{{ selectedDriver.delai }}</div>
      </div>

      <!-- Vehicle Photos -->
      <div class="detail-row mb-3">
        <label class="detail-label">Photos du véhicule</label>
        <div class="detail-value">
          <div class="row g-2">
            <div class="col-6">
              <small class="text-muted d-block mb-1">Recto</small>
              <img [src]="selectedDriver.photoVehiculeRecto || 'assets/images/no-image.png'" 
                   alt="Véhicule Recto" 
                   class="img-thumbnail w-100"
                   style="height: 120px; object-fit: cover; cursor: pointer;"
                   (click)="viewFullImage(selectedDriver.photoVehiculeRecto)">
            </div>
            <div class="col-6">
              <small class="text-muted d-block mb-1">Verso</small>
              <img [src]="selectedDriver.photoVehiculeVerso || 'assets/images/no-image.png'" 
                   alt="Véhicule Verso" 
                   class="img-thumbnail w-100"
                   style="height: 120px; object-fit: cover; cursor: pointer;"
                   (click)="viewFullImage(selectedDriver.photoVehiculeVerso)">
            </div>
          </div>
        </div>
      </div>

      <div class="detail-row mb-3">
        <label class="detail-label">Option de contact</label>
        <div class="detail-value">
          <div class="btn-group w-100" role="group">
            <input type="radio" 
                   class="btn-check" 
                   name="contactOption" 
                   id="messageOption" 
                   [value]="'MESSAGE'"
                   [(ngModel)]="selectedContactMethod"
                   [disabled]="isRequestPending"
                   autocomplete="off">
            <label class="btn btn-outline-primary btn-sm" for="messageOption">
              <i class="bi bi-chat-dots me-1"></i> Message direct
            </label>

            <input type="radio" 
                   class="btn-check" 
                   name="contactOption" 
                   id="callOption" 
                   [value]="'CALL'"
                   [(ngModel)]="selectedContactMethod"
                   [disabled]="isRequestPending"
                   autocomplete="off">
            <label class="btn btn-outline-primary btn-sm" for="callOption">
              <i class="bi bi-telephone me-1"></i> Appel
            </label>
          </div>
        </div>
      </div>

      <!-- Orders Dropdown -->
      <div class="detail-row mb-3">
        <label class="detail-label">Commande à livrer</label>
        <div class="detail-value">
          <select class="form-select"
                  [(ngModel)]="selectedOrder"
                  [ngModelOptions]="{standalone: true}">
            <option [ngValue]="null" disabled selected>Choisir une commande...</option>
            <option *ngFor="let order of ordersEnTraitement" [ngValue]="order">
              #{{ order.numberOrder }} - {{ order.firstname }} {{ order.lastname }} ({{ order.totalPrice | number:'1.2-2' }} MAD)
            </option>
          </select>
        </div>
      </div>

      <!-- Request Status -->
      <div class="alert alert-info mb-3" *ngIf="isRequestPending">
        <div class="d-flex align-items-center">
          <div class="spinner-border spinner-border-sm me-2" role="status">
            <span class="visually-hidden">Chargement...</span>
          </div>
          <span>{{ requestStatus }}</span>
        </div>
      </div>
    </div>

    <div class="d-grid gap-2">
      <button class="btn btn-outline-secondary" 
              (click)="closeDriverDrawer()"
              [disabled]="isRequestPending">
        {{ isRequestPending ? 'Fermer' : 'Annuler' }}
      </button>
      
      <button class="btn btn-danger" 
              *ngIf="isRequestPending"
              (click)="cancelRequest()">
        <i class="bi bi-x-circle me-1"></i> Annuler la demande
      </button>
      
      <button class="btn btn-primary" 
              *ngIf="!isRequestPending"
              (click)="confirmDriver()">
        <i class="bi bi-check-circle me-1"></i> Confirmer et envoyer
      </button>
    </div>
  </div>
</div>

<!-- Backdrop -->
<div class="offcanvas-backdrop fade" 
     [class.show]="driverDrawerVisible"
     [style.display]="driverDrawerVisible ? 'block' : 'none'"
     (click)="closeDriverDrawer()"></div>
