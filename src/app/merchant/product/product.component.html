<div class="container-fluid p-3 p-md-5">
  <div class="pb-2 section-header d-flex justify-content-between align-items-center">
    <h2 class="text-dark"><i class="bi bi-grid-3x3-gap"></i> Mes Produits</h2>
    <div class="search-container position-relative">
      <input 
        type="text" 
        class="search-input" 
        placeholder="Rechercher un produit..."
        [(ngModel)]="searchTerm"
        (input)="onSearchChange($event.target.value)"/>
        <i class="bi bi-search search-icon"></i>
      </div>
  </div>
  <!--
  <div class="search-container">
            <input 
              type="text" 
              class="search-input" 
              placeholder="Rechercher un magasin..."
              [(ngModel)]="storeSearchTerm"
              (input)="onStoreSearchChange($event)"/>
            <i class="bi bi-search search-icon"></i>
          </div>
  -->
  <div class="table-responsive">
    <table class="table table-sm table-hover">
    <thead class="table-light">
      <tr>
        <th class="d-none d-lg-table-cell text-dark">Image</th>
        <th class="text-dark">Nom</th>
        <th class="text-dark">Prix</th>
        <th class="d-none d-md-table-cell text-dark">Stock</th>
        <th class="d-none d-xl-table-cell text-dark">Tailles</th>
        <th class="d-none d-lg-table-cell text-dark">Catégorie</th>
        <th class="d-none d-md-table-cell text-dark">Status</th>
        <th class="d-none d-xl-table-cell text-dark">Date création</th>
        <th class="text-dark">Action</th>
      </tr>
    </thead>
    <tbody>
    <tr *ngFor="let product of products; let i = index">
      <td class="d-none d-lg-table-cell">
        <img [src]="getFirstImage(product)" 
              alt="{{ product.nom }}" 
              class="img-thumbnail" 
              style="width: 50px; height: 50px; object-fit: cover;">
      </td>
      <td>
        <div class="d-flex align-items-center">
          <img [src]="getFirstImage(product)" 
                alt="{{ product.nom }}" 
                class="img-thumbnail d-lg-none me-2" 
                style="width: 40px; height: 40px; object-fit: cover;">
          <span class="text-dark">{{ product.nom }}</span>
        </div>
      </td>
      <td class="text-nowrap text-dark">{{ product.prix | currency:'MAD ' }}</td>
      <td class="d-none d-md-table-cell text-dark">{{ product.stock }}</td>
      <td class="d-none d-xl-table-cell text-dark">{{ getSizes(product) }}</td>
      <td class="d-none d-lg-table-cell text-dark">{{ getCategorieName(product) }}</td>
      <td class="d-none d-md-table-cell text-dark">
        <div class="form-check form-switch">
          <input 
            class="form-check-input" 
            type="checkbox" 
            id="'flexSwitchCheckChecked-' + i"
            [checked]="isProductActive(product)"
            (change)="toggleProductStatus(getProductId(product))"
            role="switch">
        </div>
      </td>
      <td class="d-none d-xl-table-cell text-nowrap text-dark">{{ getDateCreated(product) | date:'short' }}</td>
      <td>
        <div class="btn-group-vertical d-md-none" role="group">
          <button class="btn btn-sm btn-warning mb-1" 
              (click)="openEditDrawer(product)"
              title="Modifier">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-danger mb-1" 
                  (click)="deleteProduct(getProductId(product))" 
                  title="Supprimer">
            <i class="bi bi-trash"></i>
          </button>
          <button class="btn btn-sm btn-primary"  
                  (click)="openDetailsDrawer(product)"
                  title="Détails">
            <i class="bi bi-door-open"></i>
          </button>
        </div>
        <div class="btn-group d-none d-md-flex" role="group">
          <button class="btn btn-sm btn-warning" 
              (click)="openEditDrawer(product)"
              title="Modifier">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-danger" 
                  (click)="deleteProduct(getProductId(product))" 
                  title="Supprimer">
            <i class="bi bi-trash"></i>
          </button>
          <button class="btn btn-sm btn-primary"  
                  (click)="openDetailsDrawer(product)"
                  title="Détails">
            <i class="bi bi-door-open"></i>
          </button>
        </div>
      </td>
    </tr>
    </tbody>
    </table>
  </div>

<div class="row mt-3 g-2">
    <div class="col-12 col-md-6 text-center text-md-start">
      <p class="text-dark mb-2 mb-md-0 small">
        Affichage de {{ currentPage * pageSize + 1 }} à 
        {{ (currentPage + 1) * pageSize > totalItems ? totalItems : (currentPage + 1) * pageSize }} 
        sur {{ totalItems }} produits
      </p>
    </div>
    <div class="col-12 col-md-6">
      <nav aria-label="Page navigation">
        <ul class="pagination pagination-sm justify-content-center justify-content-md-end mb-0">
          <li class="page-item disabled" [class.disabled]="currentPage === 0">
            <a class="page-link" (click)="previousPage()" style="cursor: pointer;" tabindex="-1">
              <span class="d-none d-sm-inline">Précédent</span>
              <span class="d-sm-none">&laquo;</span>
            </a>
          </li>
          <li class="page-item" 
              *ngFor="let page of getPageNumbers()"
              [class.active]="page === currentPage">
            <a class="page-link" (click)="goToPage(page)" style="cursor: pointer;">
              {{ page + 1 }}
            </a>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
            <a class="page-link" (click)="nextPage()" style="cursor: pointer;">
              <span class="d-none d-sm-inline">Suivant</span>
              <span class="d-sm-none">&raquo;</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- Edit Product Drawer -->
<nz-drawer
  *ngIf="editDrawerVisible"
  [nzBodyStyle]="{ overflow: 'auto' }"
  [nzMaskClosable]="false"
  [nzWidth]="getDrawerWidth()"
  [nzVisible]="editDrawerVisible"
  nzTitle="Modifier le produit"
  [nzFooter]="editFooterTpl"
  (nzOnClose)="closeEditDrawer()">
  <div *nzDrawerContent class="px-2 px-md-3">
    <form>
      <div class="row">
        <div class="col-12 col-md-6 mb-3">
          <label class="form-label text-dark">Nom du produit *</label>
          <input type="text" class="form-control" 
                 [(ngModel)]="editingProduct.nom" 
                 name="nom" />
        </div>
        <div class="col-12 col-md-6 mb-3">
          <label class="form-label text-dark">Prix (MAD) *</label>
          <input type="number" class="form-control" 
                 [(ngModel)]="editingProduct.prix" 
                 name="prix" />
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label text-dark">Description</label>
        <textarea class="form-control" rows="3"
                  [(ngModel)]="editingProduct.description" 
                  name="description"></textarea>
      </div>
      <div class="row">
        <div class="col-12 col-md-6 mb-3">
          <label class="form-label text-dark">Catégorie *</label>
          <select class="form-select"
                  [(ngModel)]="editingProduct.categorieId"
                  name="categorieId">
            <option *ngFor="let cat of categories" [value]="cat.id">
              {{ cat.nom }}
            </option>
          </select>
        </div>
        <div class="col-12 col-md-6 mb-3">
          <label class="form-label text-dark">Stock *</label>
          <input type="number" class="form-control" 
                 [(ngModel)]="editingProduct.stock" 
                 name="stock" />
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label text-dark">Tailles disponibles</label>
        <div class="input-group mb-2">
          <input type="text" class="form-control" 
                 placeholder="Ex: S, M, L, XL" 
                 [(ngModel)]="sizesInput" 
                 name="sizesInput">
          <button class="btn btn-outline-secondary" type="button" 
                  (click)="addSize()">
            <i class="bi bi-plus"></i>
          </button>
        </div>
        <div class="d-flex flex-wrap gap-2" *ngIf="editingProduct.sizes && editingProduct.sizes.length > 0">
          <span *ngFor="let size of editingProduct.sizes; let i = index" 
                class="badge bg-primary d-flex align-items-center">
            {{ size.sizeName }}
            <button type="button" class="btn-close btn-close-white ms-2" 
                    (click)="removeSize(i)"></button>
          </span>
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label text-dark">Couleurs du produit</label>
        <div class="row g-2 mb-2">
          <div class="col-12 col-sm-6">
            <input type="text" class="form-control" 
                   placeholder="Nom de la couleur" 
                   [(ngModel)]="colorName" 
                   name="colorName">
          </div>
          <div class="col-12 col-sm-6">
            <div class="input-group">
              <input type="color" class="form-control form-control-color" 
                     [(ngModel)]="colorCode" 
                     name="colorCode">
              <button class="btn btn-outline-secondary" type="button" 
                      (click)="addColor()">
                <i class="bi bi-plus"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="d-flex flex-wrap gap-2" *ngIf="editingProduct.colors && editingProduct.colors.length > 0">
          <div *ngFor="let color of editingProduct.colors; let i = index" 
               class="badge bg-light text-dark border d-flex align-items-center p-2">
            <span class="color-preview me-2" 
                  [style.background-color]="color.colorCode"
                  style="width: 20px; height: 20px; border-radius: 3px;"></span>
            {{ color.colorName }}
            <button type="button" class="btn-close ms-2" 
                    (click)="removeColor(i)"></button>
          </div>
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label text-dark">Images du produit</label>
        <input type="file" class="form-control" 
               multiple accept="image/*" 
               (change)="onFilesSelected($event)">
        <div class="mt-2 d-flex flex-wrap gap-2" *ngIf="productImages.length">
          <div *ngFor="let file of productImages; let i = index" class="position-relative">
            <img [src]="file.preview" alt="preview" 
                 class="rounded border" 
                 style="width: 80px; height: 80px; object-fit: cover;">
            <button type="button" 
                    class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1 p-1" 
                    (click)="removeImage(i)">
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12 col-md-6 mb-3">
          <label class="form-label text-dark">Statut</label>
          <select class="form-select"
                  [(ngModel)]="editingProduct.status"
                  name="status">
            <option value="ACTIF">Actif</option>
            <option value="INACTIF">Inactif</option>
          </select>
        </div>
        <div class="col-12 col-md-6 mb-3">
          <label class="form-label text-dark d-block">Actif pour la vente</label>
          <div class="form-check form-switch mt-2">
            <input class="form-check-input" type="checkbox" 
                   [(ngModel)]="editingProduct.isActiveProduct"
                   name="isActiveProduct">
            <label class="form-check-label text-dark">
              Produit actif
            </label>
          </div>
        </div>
      </div>
    </form>
  </div>
  <ng-template #editFooterTpl>
    <div class="d-flex flex-column flex-sm-row justify-content-end gap-2 w-100">
      <button class="btn btn-secondary" 
              (click)="closeEditDrawer()" 
              [disabled]="isUpdating">
        Annuler
      </button>
      <button class="btn btn-primary" 
              (click)="updateProduct()" 
              [disabled]="isUpdating">
        {{ isUpdating ? 'Modification...' : 'Modifier' }}
      </button>
    </div>
  </ng-template>
</nz-drawer>

<!-- Product Details Drawer -->
<nz-drawer
  *ngIf="detailsDrawerVisible"
  [nzBodyStyle]="{ overflow: 'auto' }"
  [nzMaskClosable]="true"
  [nzWidth]="getDrawerWidth()"
  [nzVisible]="detailsDrawerVisible"
  nzTitle="Détails du produit"
  (nzOnClose)="closeDetailsDrawer()">
  <div *nzDrawerContent class="px-2 px-md-3">
    <div class="container-fluid" *ngIf="viewingProduct">
      
      <!-- Product Name -->
      <div class="mb-3 mb-md-4">
        <h4 class="text-primary fs-5 fs-md-4">{{ viewingProduct.nom }}</h4>
        <p class="text-dark small" *ngIf="viewingProduct.description">
          {{ viewingProduct.description }}
        </p>
      </div>

      <!-- Product Images -->
      <div class="mb-3 mb-md-4">
        <label class="fw-bold d-block mb-2 small">Images du produit</label>
        <div class="row g-2">
          <div class="col-12" *ngIf="viewingProduct.images && viewingProduct.images.length > 0">
            <!-- Main Image -->
            <div class="text-center mb-3">
              <img [src]="selectedImage || viewingProduct.images[0].imageUrl" 
                   alt="{{ viewingProduct.nom }}" 
                   class="img-fluid rounded border"
                   style="max-height: 300px; width: 100%; object-fit: contain;">
            </div>
            
            <!-- Thumbnail Gallery -->
            <div class="d-flex gap-2 overflow-auto pb-2" *ngIf="viewingProduct.images.length > 1">
              <div *ngFor="let image of viewingProduct.images; let i = index" 
                   class="flex-shrink-0">
                <img [src]="image.imageUrl" 
                     [alt]="'Image ' + (i + 1)" 
                     class="img-thumbnail cursor-pointer"
                     [class.border-primary]="selectedImage === image.imageUrl"
                     style="width: 60px; height: 60px; object-fit: cover; cursor: pointer;"
                     (click)="selectImage(image.imageUrl)">
              </div>
            </div>
          </div>
          <div class="col-12" *ngIf="!viewingProduct.images || viewingProduct.images.length === 0">
            <img src="assets/images/no-image.png" 
                 alt="Pas d'image" 
                 class="img-fluid rounded border"
                 style="max-height: 200px;">
          </div>
        </div>
      </div>

      <!-- Price and Stock -->
      <div class="row mb-3 mb-md-4">
        <div class="col-6">
          <label class="fw-bold d-block mb-2 small text-dark">Prix</label>
          <h5 class="text-success fs-6 fs-md-5">{{ viewingProduct.prix | currency:'MAD ' }}</h5>
        </div>
        <div class="col-6">
          <label class="fw-bold d-block mb-2 small text-dark">Stock disponible</label>
          <h5 class="fs-6 fs-md-5"
              [class.text-danger]="viewingProduct.stock < 10" 
              [class.text-warning]="viewingProduct.stock >= 10 && viewingProduct.stock < 50"
              [class.text-success]="viewingProduct.stock >= 50">
            {{ viewingProduct.stock }} <span class="small">unités</span>
          </h5>
        </div>
      </div>

      <!-- Colors -->
      <div class="mb-3 mb-md-4" *ngIf="viewingProduct.colors && viewingProduct.colors.length > 0">
        <label class="fw-bold d-block mb-2 small text-dark">Couleurs disponibles</label>
        <div class="d-flex flex-wrap gap-2">
          <div *ngFor="let color of viewingProduct.colors" 
               class="d-flex align-items-center border rounded p-2">
            <span class="color-box me-2" 
                  [style.background-color]="color.colorCode"
                  style="width: 30px; height: 30px; border-radius: 5px; border: 2px solid #ddd; display: inline-block;"></span>
            <span class="small fw-semibold text-dark">{{ color.colorName }}</span>
          </div>
        </div>
      </div>

      <!-- Sizes -->
      <div class="mb-3 mb-md-4" *ngIf="viewingProduct.sizes && viewingProduct.sizes.length > 0">
        <label class="fw-bold d-block mb-2 small text-dark">Tailles disponibles</label>
        <div class="d-flex flex-wrap gap-2">
          <span *ngFor="let size of viewingProduct.sizes" 
                class="badge bg-secondary px-2 py-1">
            {{ size.sizeName }}
          </span>
        </div>
      </div>

      <!-- Category -->
      <div class="mb-3 mb-md-4">
        <label class="fw-bold d-block mb-2 small text-dark">Catégorie</label>
        <span class="badge bg-info px-2 py-1">
          {{ getCategorieName(viewingProduct) }}
        </span>
      </div>

      <!-- Status -->
      <div class="mb-3 mb-md-4">
        <div class="row">
          <div class="col-6">
            <label class="fw-bold d-block mb-2 small text-dark">Statut</label>
            <span class="badge px-2 py-1"
                  [class.bg-success]="viewingProduct.status === 'ACTIF'"
                  [class.bg-danger]="viewingProduct.status === 'INACTIF'">
              {{ viewingProduct.status }}
            </span>
          </div>
          <div class="col-6">
            <label class="fw-bold d-block mb-2 small text-dark">Actif pour la vente</label>
            <span class="badge px-2 py-1"
                  [class.bg-success]="viewingProduct.isActiveProduct"
                  [class.bg-secondary]="!viewingProduct.isActiveProduct">
              {{ viewingProduct.isActiveProduct ? 'Oui' : 'Non' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Date Created -->
      <div class="mb-3">
        <label class="fw-bold d-block mb-2 small text-dark">Date de création</label>
        <p class="text-dark small mb-0">{{ getDateCreated(viewingProduct) | date:'medium' }}</p>
      </div>

    </div>
  </div>
</nz-drawer>