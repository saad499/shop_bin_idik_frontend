<header class="header">
  <nav class="navbar navbar-expand-lg w-100">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <img src="assets/images/logos.jpeg" alt="Logo" class="logo" />
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" (click)="openDrawer()" style="cursor:pointer;">
              Ajouter <i class="bi bi-plus"></i>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" 
               routerLink="/merchant/product" 
               routerLinkActive="active" 
               (click)="navigateToProducts()"
               [routerLinkActiveOptions]="{exact: false}">Mes produits</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" routerLink="/merchant/order" routerLinkActive="active" [routerLinkActiveOptions]="{exact: false}">Commandes</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" routerLink="/merchant/delivery" routerLinkActive="active" [routerLinkActiveOptions]="{exact: false}">Livreurs</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
</header>

<!-- Product Drawer -->
<nz-drawer
  *ngIf="visible"
  [nzBodyStyle]="{ overflow: 'auto' }"
  [nzMaskClosable]="false"
  [nzWidth]="getDrawerWidth()"
  [nzVisible]="visible"
  nzTitle="Ajouter un produit"
  [nzFooter]="footerTpl"
  (nzOnClose)="closeDrawer()">
  
  <div *nzDrawerContent>
    <form nz-form>
      <!-- Product Name and Price -->
      <div class="row">
        <div class="col-12 col-md-6 mb-3">
          <label for="name_product">Nom du produit *</label>
          <input nz-input type="text" placeholder="Nom du produit" 
                 [(ngModel)]="newProduct.nom" 
                 [ngModelOptions]="{standalone: true}" 
                 required />
        </div>
        <div class="col-12 col-md-6 mb-3">
          <label for="price">Prix (MAD) *</label>
          <input nz-input type="number" min="0" step="0.01" placeholder="0.00" 
                 [(ngModel)]="newProduct.prix" 
                 [ngModelOptions]="{standalone: true}" 
                 required />
        </div>
      </div>

      <!-- Description -->
      <div class="mb-3">
        <label for="description">Description</label>
        <textarea class="form-control" id="description" rows="3" 
                  placeholder="Description du produit"
                  [(ngModel)]="newProduct.description" 
                  [ngModelOptions]="{standalone: true}"></textarea>
      </div>

      <!-- Category and Stock -->
      <div class="row">
        <div class="col-12 col-md-4 mb-3">
          <label for="category">Catégorie *</label>
          <select
            class="form-select"
            [ngModel]="selectedValue"
            (ngModelChange)="onCategoryChange($event)"
            [ngModelOptions]="{standalone: true}"
          >
            <option value="">Sélectionner une catégorie</option>

            <option *ngFor="let cat of categories" [value]="cat.id">
                {{ cat.nom }}
            </option>
          </select>
        </div>
        
        <div class="col-auto d-flex align-items-center">
          <button type="button" class="btn btn-outline-secondary me-2" 
                  [disabled]="!selectedValue"
                  (click)="editSelectedCategory()"
                  title="Modifier la catégorie">
            <i class="bi bi-pencil"></i>
          </button>
          <button type="button" class="btn btn-outline-primary" 
                  (click)="openCategoryDrawer()"
                  title="Ajouter une catégorie">
            <i class="bi bi-plus"></i>
          </button>
        </div>

        <div class="col-12 col-md mb-3">
          <label for="stock">Stock disponible *</label>
          <input nz-input type="number" min="0" placeholder="0" 
                 [(ngModel)]="newProduct.stock" 
                 [ngModelOptions]="{standalone: true}" 
                 required />
        </div>
      </div>

      <!-- Sizes -->
      <div class="mb-3">
        <label for="sizes">Tailles disponibles</label>
        <div class="input-group">
          <input type="text" class="form-control" 
                 placeholder="Ex: S, M, L, XL" 
                 [(ngModel)]="sizesInput" 
                 [ngModelOptions]="{standalone: true}">
          <button class="btn btn-outline-secondary" type="button" 
                  (click)="addSize()" 
                  [disabled]="!sizesInput || sizesInput.trim() === ''">
            <i class="bi bi-plus"></i>
          </button>
        </div>
        <small class="text-muted">Séparez les tailles par des virgules</small>
      </div>

      <!-- Images -->
      <div class="mb-3">
        <label for="productImages">Images du produit</label>
        <input type="file" id="productImages" class="form-control" 
               multiple accept="image/*" 
               (change)="onFilesSelected($event)">
        <div class="mt-2 d-flex flex-wrap gap-2" *ngIf="productImages.length">
          <div *ngFor="let file of productImages" class="position-relative">
            <img [src]="file.preview" alt="preview" 
                 class="rounded border" 
                 style="width: 100px; height: 100px; object-fit: cover;">
          </div>
        </div>
        <small class="text-muted">Séparez les tailles par des virgules</small>
        
        <!-- Display added sizes -->
        <div class="mt-2 d-flex flex-wrap gap-2" *ngIf="newProduct.sizes.length > 0">
          <span *ngFor="let size of newProduct.sizes; let i = index" 
                class="badge bg-primary d-flex align-items-center">
            {{ size.sizeName }}
            <button type="button" class="btn-close btn-close-white ms-2" 
                    style="font-size: 0.7rem;"
                    (click)="removeSize(i)"
                    aria-label="Supprimer"></button>
          </span>
        </div>
      </div>

      <!-- Color -->
      <div class="mb-3">
        <label for="productColor">Couleurs du produit *</label>
        <div class="input-group mb-2">
          <input type="text" class="form-control" 
                 placeholder="Nom de la couleur (ex: Rouge)" 
                 [(ngModel)]="colorName" 
                 [ngModelOptions]="{standalone: true}">
          <input type="color" class="form-control form-control-color" 
                 [(ngModel)]="colorCode" 
                 [ngModelOptions]="{standalone: true}" 
                 style="max-width: 80px;">
          <button class="btn btn-outline-secondary" type="button" 
                  (click)="addColor()" 
                  [disabled]="!colorName || colorCode.trim() === ''">
            <i class="bi bi-plus"></i>
          </button>
        </div>

        <div class="d-flex flex-wrap gap-2" *ngIf="newProduct.colors.length > 0">
          <div *ngFor="let color of newProduct.colors; let i = index" 
               class="badge bg-light text-dark border d-flex align-items-center p-2">
            <span class="color-preview me-2" 
                  [style.background-color]="color.colorCode"
                  style="width: 20px; height: 20px; border-radius: 3px; border: 1px solid #ddd;"></span>
            {{ color.colorName }}
            <button type="button" class="btn-close ms-2" 
                    style="font-size: 0.7rem;"
                    (click)="removeColor(i)"
                    aria-label="Supprimer"></button>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label for="productImages">Images du produit *</label>
        <input type="file" id="productImages" class="form-control" 
               multiple accept="image/*" 
               (change)="onFilesSelected($event)">
        <small class="text-muted">Vous pouvez sélectionner plusieurs images</small>
        
        <div class="mt-2 d-flex flex-wrap gap-2" *ngIf="productImages.length">
          <div *ngFor="let file of productImages; let i = index" class="position-relative">
            <img [src]="file.preview" alt="preview" 
                 class="rounded border" 
                 style="width: 100px; height: 100px; object-fit: cover;">
            <button type="button" 
                    class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                    style="padding: 2px 6px; font-size: 0.75rem;"
                    (click)="removeImage(i)">
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label for="status">Statut du produit *</label>
        <select class="form-select"
                [(ngModel)]="newProduct.status"
                [ngModelOptions]="{standalone: true}">
          <option [value]="statusProduct.ACTIF">Actif</option>
          <option [value]="statusProduct.INACTIF">Inactif</option>
        </select>
      </div>

      <div class="mb-3">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" 
                 id="isActiveProduct"
                 [(ngModel)]="newProduct.isActiveProduct"
                 [ngModelOptions]="{standalone: true}">
          <label class="form-check-label" for="isActiveProduct">
            Produit actif pour la vente
          </label>
        </div>
      </div>
    </form>
  </div>

  <ng-template #footerTpl>
    <div class="d-flex justify-content-end gap-2">
      <button nz-button (click)="closeDrawer()">
        Annuler
      </button><!-- [disabled]="isAddingProduct"-->
      <button nz-button nzType="primary" 
              (click)="addProduct()" 
              [disabled]="isAddingProduct" 
              [nzLoading]="isAddingProduct">
        Ajouter
      </button>
    </div>
  </ng-template>
</nz-drawer>

<!-- Category Drawer -->
<nz-drawer 
  *ngIf="categoryDrawerVisible"
  [nzVisible]="categoryDrawerVisible"
  [nzTitle]="selectedCategory ? 'Modifier la catégorie' : 'Ajouter une catégorie'"
  [nzWidth]="400"
  (nzOnClose)="closeCategoryDrawer()">
  
  <form nz-form *nzDrawerContent>
    <div class="mb-3">
      <label for="categoryName" class="form-label">Nom *</label>
      <input id="categoryName" class="form-control" 
             [(ngModel)]="newCategory.nom" 
             [ngModelOptions]="{standalone: true}"
             required />
    </div>
    <div class="mb-3">
      <label for="categoryDescription" class="form-label">Description</label>
      <textarea id="categoryDescription" class="form-control" rows="3"
                [(ngModel)]="newCategory.description" 
                [ngModelOptions]="{standalone: true}"></textarea>
    </div>
    <button 
    nz-button 
    type="button"
    nzType="primary" 
            (click)="saveCategory($event)" 
            [disabled]="isAddingCategory || !newCategory.nom" 
            [nzLoading]="isAddingCategory">
      {{ selectedCategory ? 'Modifier' : 'Ajouter' }}
    </button>
  </form>
</nz-drawer>