<div class="class container p-5">
  <div class="row mb-3">
    <div class="col-md-4 offset-md-8 d-flex justify-content-end">
      <input 
        type="text" 
        class="form-control w-auto" 
        placeholder="Rechercher un produit..." 
        [(ngModel)]="searchTerm"
        (ngModelChange)="onSearchChange($event)"/>
    </div>
  </div>
  <div class="table-responsive">
    <table class="table">
    <thead>
      <tr>
        <th>Image</th>
        <th>Nom</th>
        <th>Prix</th>
        <th>Stock</th>
        <th>Tailles</th>
        <th>Catégorie</th>
        <th>Status</th>
        <th>Date création</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
    <tr *ngFor="let product of products; let i = index">
      <td>
        <img [src]="getFirstImage(product)" 
              alt="{{ product.nom }}" 
              class="img-thumbnail" 
              style="width: 60px; height: 60px; object-fit: cover;">
      </td>
      <td>{{ product.nom }}</td>
      <td>{{ product.prix | currency:'MAD ' }}</td>
      <td>{{ product.stock }}</td>
      <td>{{ getSizes(product) }}</td>
      <td>{{ getCategorieName(product) }}</td>
      <td>
        <div class="form-check form-switch">
          <input 
            class="form-check-input" 
            type="checkbox" 
            id="'flexSwitchCheckChecked-' + i"
            [checked]="isProductActive(product)"
            (change)="toggleProductStatus(getProductId(product))"
            role="switch">
        </div>
      </td>
      <td>{{ getDateCreated(product) | date:'short' }}</td>
      <td>
        <button class="btn btn-sm btn-warning me-2" 
            (click)="openEditDrawer(product)"
            title="Modifier">
          <i class="bi bi-pencil"></i>
        </button>
        <button class="btn btn-sm btn-danger me-2" 
                (click)="deleteProduct(getProductId(product))" 
                title="Supprimer">
          <i class="bi bi-trash"></i>
        </button>
        <button class="btn btn-sm btn-primary"  
                (click)="openDetailsDrawer(product)"
                title="Désactiver">
          <i class="bi bi-door-open"></i>
        </button>
      </td>
    </tr>
    </tbody>
    </table>
  </div>

<div class="row mt-3">
    <div class="col-md-6">
      <p class="text-muted">
        Affichage de {{ currentPage * pageSize + 1 }} à 
        {{ (currentPage + 1) * pageSize > totalItems ? totalItems : (currentPage + 1) * pageSize }} 
        sur {{ totalItems }} produits
      </p>
    </div>
    <div class="col-md-6">
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-end">
          <li class="page-item" [class.disabled]="currentPage === 0">
            <a class="page-link" (click)="previousPage()" style="cursor: pointer;" tabindex="-1">
              Previous
            </a>
          </li>
          <li class="page-item" 
              *ngFor="let page of getPageNumbers()"
              [class.active]="page === currentPage">
            <a class="page-link" (click)="goToPage(page)" style="cursor: pointer;">
              {{ page + 1 }}
            </a>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
            <a class="page-link" (click)="nextPage()" style="cursor: pointer;">
              Next
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- Edit Product Drawer -->
<nz-drawer
  *ngIf="editDrawerVisible"
  [nzBodyStyle]="{ overflow: 'auto' }"
  [nzMaskClosable]="false"
  [nzWidth]="600"
  [nzVisible]="editDrawerVisible"
  nzTitle="Modifier le produit"
  [nzFooter]="editFooterTpl"
  (nzOnClose)="closeEditDrawer()">
  <div *nzDrawerContent>
    <form>
      <div class="row">
        <div class="col-12 col-md-6 mb-3">
          <label>Nom du produit *</label>
          <input type="text" class="form-control" 
                 [(ngModel)]="editingProduct.nom" 
                 name="nom" />
        </div>
        <div class="col-12 col-md-6 mb-3">
          <label>Prix (MAD) *</label>
          <input type="number" class="form-control" 
                 [(ngModel)]="editingProduct.prix" 
                 name="prix" />
        </div>
      </div>
      <div class="mb-3">
        <label>Description</label>
        <textarea class="form-control" rows="3"
                  [(ngModel)]="editingProduct.description" 
                  name="description"></textarea>
      </div>
      <div class="row">
        <div class="col-12 col-md-6 mb-3">
          <label>Catégorie *</label>
          <select class="form-select"
                  [(ngModel)]="editingProduct.categorieId"
                  name="categorieId">
            <option *ngFor="let cat of categories" [value]="cat.id">
              {{ cat.nom }}
            </option>
          </select>
        </div>
        <div class="col-12 col-md-6 mb-3">
          <label>Stock *</label>
          <input type="number" class="form-control" 
                 [(ngModel)]="editingProduct.stock" 
                 name="stock" />
        </div>
      </div>
      <div class="mb-3">
        <label>Tailles disponibles</label>
        <div class="input-group mb-2">
          <input type="text" class="form-control" 
                 placeholder="Ex: S, M, L, XL" 
                 [(ngModel)]="sizesInput" 
                 name="sizesInput">
          <button class="btn btn-outline-secondary" type="button" 
                  (click)="addSize()">
            <i class="bi bi-plus"></i>
          </button>
        </div>
        <div class="d-flex flex-wrap gap-2" *ngIf="editingProduct.sizes && editingProduct.sizes.length > 0">
          <span *ngFor="let size of editingProduct.sizes; let i = index" 
                class="badge bg-primary d-flex align-items-center">
            {{ size.sizeName }}
            <button type="button" class="btn-close btn-close-white ms-2" 
                    (click)="removeSize(i)"></button>
          </span>
        </div>
      </div>
      <div class="mb-3">
        <label>Couleurs du produit</label>
        <div class="input-group mb-2">
          <input type="text" class="form-control" 
                 placeholder="Nom de la couleur" 
                 [(ngModel)]="colorName" 
                 name="colorName">
          <input type="color" class="form-control form-control-color" 
                 [(ngModel)]="colorCode" 
                 name="colorCode"
                 style="max-width: 80px;">
          <button class="btn btn-outline-secondary" type="button" 
                  (click)="addColor()">
            <i class="bi bi-plus"></i>
          </button>
        </div>
        <div class="d-flex flex-wrap gap-2" *ngIf="editingProduct.colors && editingProduct.colors.length > 0">
          <div *ngFor="let color of editingProduct.colors; let i = index" 
               class="badge bg-light text-dark border d-flex align-items-center p-2">
            <span class="color-preview me-2" 
                  [style.background-color]="color.colorCode"
                  style="width: 20px; height: 20px; border-radius: 3px;"></span>
            {{ color.colorName }}
            <button type="button" class="btn-close ms-2" 
                    (click)="removeColor(i)"></button>
          </div>
        </div>
      </div>
      <div class="mb-3">
        <label>Images du produit</label>
        <input type="file" class="form-control" 
               multiple accept="image/*" 
               (change)="onFilesSelected($event)">
        <div class="mt-2 d-flex flex-wrap gap-2" *ngIf="productImages.length">
          <div *ngFor="let file of productImages; let i = index" class="position-relative">
            <img [src]="file.preview" alt="preview" 
                 class="rounded border" 
                 style="width: 100px; height: 100px; object-fit: cover;">
            <button type="button" 
                    class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                    (click)="removeImage(i)">
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="mb-3">
        <label>Statut</label>
        <select class="form-select"
                [(ngModel)]="editingProduct.status"
                name="status">
          <option value="ACTIF">Actif</option>
          <option value="INACTIF">Inactif</option>
        </select>
      </div>
      <div class="mb-3">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" 
                 [(ngModel)]="editingProduct.isActiveProduct"
                 name="isActiveProduct">
          <label class="form-check-label">
            Produit actif pour la vente
          </label>
        </div>
      </div>
    </form>
  </div>
  <ng-template #editFooterTpl>
    <div class="d-flex justify-content-end gap-2">
      <button class="btn btn-secondary" 
              (click)="closeEditDrawer()" 
              [disabled]="isUpdating">
        Annuler
      </button>
      <button class="btn btn-primary" 
              (click)="updateProduct()" 
              [disabled]="isUpdating">
        {{ isUpdating ? 'Modification...' : 'Modifier' }}
      </button>
    </div>
  </ng-template>
</nz-drawer>

<!-- Product Details Drawer -->
<nz-drawer
  *ngIf="detailsDrawerVisible"
  [nzBodyStyle]="{ overflow: 'auto' }"
  [nzMaskClosable]="true"
  [nzWidth]="700"
  [nzVisible]="detailsDrawerVisible"
  nzTitle="Détails du produit"
  (nzOnClose)="closeDetailsDrawer()">
  
  <div *nzDrawerContent>
    <div class="container-fluid" *ngIf="viewingProduct">
      
      <!-- Product Name -->
      <div class="mb-4">
        <h4 class="text-primary">{{ viewingProduct.nom }}</h4>
        <p class="text-muted" *ngIf="viewingProduct.description">
          {{ viewingProduct.description }}
        </p>
      </div>

      <!-- Product Images -->
      <div class="mb-4">
        <label class="fw-bold d-block mb-2">Images du produit</label>
        <div class="row g-2">
          <div class="col-12" *ngIf="viewingProduct.images && viewingProduct.images.length > 0">
            <!-- Main Image -->
            <div class="text-center mb-3">
              <img [src]="selectedImage || viewingProduct.images[0].imageUrl" 
                   alt="{{ viewingProduct.nom }}" 
                   class="img-fluid rounded border"
                   style="max-height: 400px; width: 100%; object-fit: contain;">
            </div>
            
            <!-- Thumbnail Gallery -->
            <div class="d-flex gap-2 overflow-auto pb-2" *ngIf="viewingProduct.images.length > 1">
              <div *ngFor="let image of viewingProduct.images; let i = index" 
                   class="flex-shrink-0">
                <img [src]="image.imageUrl" 
                     [alt]="'Image ' + (i + 1)" 
                     class="img-thumbnail cursor-pointer"
                     [class.border-primary]="selectedImage === image.imageUrl"
                     style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;"
                     (click)="selectImage(image.imageUrl)">
              </div>
            </div>
          </div>
          <div class="col-12" *ngIf="!viewingProduct.images || viewingProduct.images.length === 0">
            <img src="assets/images/no-image.png" 
                 alt="Pas d'image" 
                 class="img-fluid rounded border"
                 style="max-height: 300px;">
          </div>
        </div>
      </div>

      <!-- Price and Stock -->
      <div class="row mb-4">
        <div class="col-6">
          <label class="fw-bold d-block mb-2">Prix</label>
          <h5 class="text-success">{{ viewingProduct.prix | currency:'MAD ' }}</h5>
        </div>
        <div class="col-6">
          <label class="fw-bold d-block mb-2">Stock disponible</label>
          <h5 [class.text-danger]="viewingProduct.stock < 10" 
              [class.text-warning]="viewingProduct.stock >= 10 && viewingProduct.stock < 50"
              [class.text-success]="viewingProduct.stock >= 50">
            {{ viewingProduct.stock }} unités
          </h5>
        </div>
      </div>

      <!-- Colors -->
      <div class="mb-4" *ngIf="viewingProduct.colors && viewingProduct.colors.length > 0">
        <label class="fw-bold d-block mb-2">Couleurs disponibles</label>
        <div class="d-flex flex-wrap gap-3">
          <div *ngFor="let color of viewingProduct.colors" 
               class="d-flex align-items-center border rounded p-2">
            <span class="color-box me-2" 
                  [style.background-color]="color.colorCode"
                  style="width: 40px; height: 40px; border-radius: 5px; border: 2px solid #ddd; display: inline-block;"></span>
            <span class="fw-semibold">{{ color.colorName }}</span>
          </div>
        </div>
      </div>

      <!-- Sizes -->
      <div class="mb-4" *ngIf="viewingProduct.sizes && viewingProduct.sizes.length > 0">
        <label class="fw-bold d-block mb-2">Tailles disponibles</label>
        <div class="d-flex flex-wrap gap-2">
          <span *ngFor="let size of viewingProduct.sizes" 
                class="badge bg-secondary fs-6 px-3 py-2">
            {{ size.sizeName }}
          </span>
        </div>
      </div>

      <!-- Category -->
      <div class="mb-4">
        <label class="fw-bold d-block mb-2">Catégorie</label>
        <span class="badge bg-info fs-6 px-3 py-2">
          {{ getCategorieName(viewingProduct) }}
        </span>
      </div>

      <!-- Status -->
      <div class="mb-4">
        <div class="row">
          <div class="col-6">
            <label class="fw-bold d-block mb-2">Statut</label>
            <span class="badge fs-6 px-3 py-2"
                  [class.bg-success]="viewingProduct.status === 'ACTIF'"
                  [class.bg-danger]="viewingProduct.status === 'INACTIF'">
              {{ viewingProduct.status }}
            </span>
          </div>
          <div class="col-6">
            <label class="fw-bold d-block mb-2">Actif pour la vente</label>
            <span class="badge fs-6 px-3 py-2"
                  [class.bg-success]="viewingProduct.isActiveProduct"
                  [class.bg-secondary]="!viewingProduct.isActiveProduct">
              {{ viewingProduct.isActiveProduct ? 'Oui' : 'Non' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Date Created -->
      <div class="mb-4">
        <label class="fw-bold d-block mb-2">Date de création</label>
        <p class="text-muted">{{ getDateCreated(viewingProduct) | date:'full' }}</p>
      </div>

    </div>
  </div>
</nz-drawer>